<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Post Board</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f9c74f;
            --danger: #f94144;
            --gray: #6c757d;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }
        
        h1 {
            color: var(--primary);
            font-size: 2.5rem;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--secondary);
        }
        
        .btn-secondary {
            background: var(--gray);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #d90429;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #2a9d8f;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger);
        }
        
        .status-indicator.connected {
            background: var(--success);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 20px;
        }
        
        .post-form {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            height: fit-content;
        }
        
        .connection-panel {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }
        
        h2 {
            margin-bottom: 20px;
            color: var(--secondary);
        }
        
        h3 {
            margin: 15px 0 10px;
            color: var(--primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .peer-id-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .peer-id-input {
            flex: 1;
        }
        
        .peer-list {
            margin-top: 15px;
            padding: 15px;
            background: var(--light);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .peer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .peer-item:last-child {
            border-bottom: none;
        }
        
        .posts-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .post {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .post:hover {
            transform: translateY(-5px);
        }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .post-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .post-time {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .post-content {
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .post-actions {
            display: flex;
            justify-content: space-between;
        }
        
        .post-expiry {
            font-size: 0.8rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .expiry-warning {
            color: var(--danger);
        }
        
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }
        
        .empty-state p {
            margin-bottom: 20px;
            color: var(--gray);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--dark);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateY(100px);
            transition: all 0.5s ease;
            z-index: 1000;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .posts-container {
                grid-template-columns: 1fr;
            }
            
            .controls {
                justify-content: center;
            }
        }
        
        @media (max-width: 576px) {
            .peer-id-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Collaborative Post Board</h1>
            <div class="controls">
                <div class="connection-status">
                    <div class="status-indicator" id="status-indicator"></div>
                    <span id="connection-count">0 peers connected</span>
                </div>
                <button class="btn-secondary" id="copy-id">Copy My ID</button>
                <button class="btn-danger" id="clear-local">Clear Local Posts</button>
                <button class="btn-success" id="connect-peer">Connect to Peer</button>
            </div>
        </header>
        
        <div class="main-content">
            <div>
                <div class="connection-panel">
                    <h2>Peer Connections</h2>
                    <div class="form-group">
                        <label for="my-peer-id">Your Peer ID</label>
                        <div class="peer-id-container">
                            <input type="text" id="my-peer-id" readonly>
                            <button class="btn-secondary" id="generate-new-id">New ID</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="connect-to-peer">Connect to another peer</label>
                        <div class="peer-id-container">
                            <input type="text" id="connect-to-peer" placeholder="Enter peer ID">
                            <button class="btn-primary" id="connect-btn">Connect</button>
                        </div>
                    </div>
                    
                    <h3>Connected Peers</h3>
                    <div class="peer-list" id="peer-list">
                        <div class="empty-state">No peers connected yet</div>
                    </div>
                </div>
                
                <div class="post-form">
                    <h2>Create a New Post</h2>
                    <div class="form-group">
                        <label for="post-title">Title</label>
                        <input type="text" id="post-title" placeholder="Enter post title">
                    </div>
                    <div class="form-group">
                        <label for="post-content">Content</label>
                        <textarea id="post-content" placeholder="What would you like to share?"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="post-expiry">Expires after (minutes)</label>
                        <input type="number" id="post-expiry" value="60" min="1">
                    </div>
                    <button class="btn-primary" id="create-post">Create Post</button>
                </div>
            </div>
            
            <div class="posts-container" id="posts-container">
                <div class="empty-state">
                    <h2>No posts yet</h2>
                    <p>Create the first post to get started!</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const postsContainer = document.getElementById('posts-container');
            const statusIndicator = document.getElementById('status-indicator');
            const connectionCount = document.getElementById('connection-count');
            const createPostBtn = document.getElementById('create-post');
            const clearLocalBtn = document.getElementById('clear-local');
            const copyIdBtn = document.getElementById('copy-id');
            const generateNewIdBtn = document.getElementById('generate-new-id');
            const connectBtn = document.getElementById('connect-btn');
            const connectPeerBtn = document.getElementById('connect-peer');
            const myPeerIdInput = document.getElementById('my-peer-id');
            const connectToPeerInput = document.getElementById('connect-to-peer');
            const peerList = document.getElementById('peer-list');
            const toast = document.getElementById('toast');
            
            // Application state
            let posts = new Map();
            let peer = null;
            let connections = new Map();
            let peerId = null;
            
            // Initialize the application
            init();
            
            function init() {
                // Load posts from localStorage
                loadPostsFromStorage();
                
                // Initialize PeerJS
                initializePeer();
                
                // Set up event listeners
                createPostBtn.addEventListener('click', createPost);
                clearLocalBtn.addEventListener('click', clearLocalPosts);
                copyIdBtn.addEventListener('click', copyPeerId);
                generateNewIdBtn.addEventListener('click', generateNewPeerId);
                connectBtn.addEventListener('click', connectToPeer);
                connectPeerBtn.addEventListener('click', focusOnPeerInput);
                
                // Check for expired posts every minute
                setInterval(removeExpiredPosts, 60000);
                
                // Render existing posts
                renderPosts();
            }
            
            function initializePeer() {
                // Generate a random peer ID if none exists in storage
                if (!localStorage.getItem('peerId')) {
                    generateNewPeerId();
                } else {
                    peerId = localStorage.getItem('peerId');
                    myPeerIdInput.value = peerId;
                }
                
                // Create PeerJS instance
                peer = new Peer(peerId, {
                    debug: 0,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:global.stun.twilio.com:3478' }
                        ]
                    }
                });
                
                peer.on('open', function(id) {
                    console.log('My peer ID is: ' + id);
                    statusIndicator.classList.add('connected');
                    updateConnectionCount();
                    showToast('Connected to signaling server');
                });
                
                peer.on('connection', function(conn) {
                    console.log('Incoming connection from: ' + conn.peer);
                    setupConnection(conn);
                });
                
                peer.on('error', function(err) {
                    console.error('Peer error:', err);
                    statusIndicator.classList.remove('connected');
                    
                    if (err.type === 'peer-unavailable') {
                        showToast('Peer unavailable: ' + err.peer);
                    } else if (err.type === 'unavailable-id') {
                        showToast('Peer ID unavailable, generating a new one');
                        generateNewPeerId();
                    } else {
                        showToast('Connection error: ' + err.message);
                    }
                });
                
                peer.on('disconnected', function() {
                    statusIndicator.classList.remove('connected');
                    showToast('Disconnected from signaling server');
                    
                    // Try to reconnect
                    setTimeout(function() {
                        peer.reconnect();
                    }, 5000);
                });
            }
            
            function setupConnection(conn) {
                conn.on('open', function() {
                    console.log('Connected to: ' + conn.peer);
                    connections.set(conn.peer, conn);
                    updateConnectionCount();
                    updatePeerList();
                    
                    // Send our current posts to the new peer
                    conn.send({
                        type: 'posts_sync',
                        data: Array.from(posts.entries())
                    });
                    
                    showToast('Connected to peer: ' + conn.peer);
                });
                
                conn.on('data', function(data) {
                    handleIncomingData(data, conn.peer);
                });
                
                conn.on('close', function() {
                    console.log('Connection closed with: ' + conn.peer);
                    connections.delete(conn.peer);
                    updateConnectionCount();
                    updatePeerList();
                    showToast('Disconnected from peer: ' + conn.peer);
                });
                
                conn.on('error', function(err) {
                    console.error('Connection error:', err);
                    connections.delete(conn.peer);
                    updateConnectionCount();
                    updatePeerList();
                });
            }
            
            function connectToPeer() {
                const peerId = connectToPeerInput.value.trim();
                if (!peerId) {
                    showToast('Please enter a peer ID');
                    return;
                }
                
                if (peerId === myPeerIdInput.value) {
                    showToast("Can't connect to yourself");
                    return;
                }
                
                if (connections.has(peerId)) {
                    showToast('Already connected to this peer');
                    return;
                }
                
                console.log('Attempting to connect to: ' + peerId);
                
                try {
                    const conn = peer.connect(peerId, {
                        reliable: true
                    });
                    
                    conn.on('open', function() {
                        setupConnection(conn);
                        connectToPeerInput.value = '';
                    });
                    
                    conn.on('error', function(err) {
                        console.error('Connection error:', err);
                        showToast('Failed to connect to peer: ' + peerId);
                    });
                } catch (err) {
                    console.error('Error creating connection:', err);
                    showToast('Error creating connection');
                }
            }
            
            function handleIncomingData(data, peerId) {
                switch (data.type) {
                    case 'post_created':
                    case 'post_updated':
                        addOrUpdatePost(data.data.id, data.data);
                        showToast('Received post from peer: ' + peerId);
                        break;
                    case 'post_deleted':
                        deletePost(data.data.id);
                        showToast('Post deleted by peer: ' + peerId);
                        break;
                    case 'posts_sync':
                        // Received a full sync of posts from a peer
                        let updatedCount = 0;
                        data.data.forEach(([id, post]) => {
                            // Only add if newer than our version or we don't have it
                            if (!posts.has(id) || (posts.has(id) && post.timestamp > posts.get(id).timestamp)) {
                                addOrUpdatePost(id, post);
                                updatedCount++;
                            }
                        });
                        
                        if (updatedCount > 0) {
                            showToast(`Synced ${updatedCount} posts from peer: ${peerId}`);
                        }
                        break;
                }
            }
            
            function createPost() {
                const title = document.getElementById('post-title').value.trim();
                const content = document.getElementById('post-content').value.trim();
                const expiryMinutes = parseInt(document.getElementById('post-expiry').value);
                
                if (!title || !content) {
                    showToast('Please fill in both title and content');
                    return;
                }
                
                const post = {
                    id: generateId(),
                    title,
                    content,
                    timestamp: Date.now(),
                    expiry: Date.now() + (expiryMinutes * 60000),
                    author: 'You'
                };
                
                addOrUpdatePost(post.id, post);
                broadcastPost(post, 'post_created');
                
                // Clear the form
                document.getElementById('post-title').value = '';
                document.getElementById('post-content').value = '';
                
                showToast('Post created successfully');
            }
            
            function addOrUpdatePost(id, post) {
                posts.set(id, post);
                savePostsToStorage();
                renderPosts();
            }
            
            function deletePost(id) {
                posts.delete(id);
                savePostsToStorage();
                renderPosts();
            }
            
            function broadcastPost(post, action) {
                const data = {
                    type: action,
                    data: post
                };
                
                connections.forEach(conn => {
                    if (conn.open) {
                        conn.send(data);
                    }
                });
            }
            
            function removeExpiredPosts() {
                const now = Date.now();
                let expiredCount = 0;
                
                posts.forEach((post, id) => {
                    if (post.expiry <= now) {
                        posts.delete(id);
                        expiredCount++;
                    }
                });
                
                if (expiredCount > 0) {
                    savePostsToStorage();
                    renderPosts();
                    console.log(`Removed ${expiredCount} expired posts`);
                }
            }
            
            function renderPosts() {
                if (posts.size === 0) {
                    postsContainer.innerHTML = `
                        <div class="empty-state">
                            <h2>No posts yet</h2>
                            <p>Create the first post to get started!</p>
                        </div>
                    `;
                    return;
                }
                
                // Clear the container
                postsContainer.innerHTML = '';
                
                // Convert posts to array and sort by timestamp (newest first)
                const postsArray = Array.from(posts.values()).sort((a, b) => b.timestamp - a.timestamp);
                
                postsArray.forEach(post => {
                    const timeAgo = getTimeAgo(post.timestamp);
                    const expiresIn = Math.max(0, post.expiry - Date.now());
                    const expiresInMinutes = Math.floor(expiresIn / 60000);
                    
                    const postElement = document.createElement('div');
                    postElement.className = 'post';
                    postElement.innerHTML = `
                        <div class="post-header">
                            <div class="post-title">${escapeHtml(post.title)}</div>
                            <div class="post-time">${timeAgo}</div>
                        </div>
                        <div class="post-content">${escapeHtml(post.content)}</div>
                        <div class="post-actions">
                            <div class="post-expiry ${expiresInMinutes < 5 ? 'expiry-warning' : ''}">
                                <span>Expires in ${expiresInMinutes} min</span>
                            </div>
                            <button class="btn-danger" data-id="${post.id}">Delete</button>
                        </div>
                    `;
                    
                    // Add event listener to delete button
                    const deleteBtn = postElement.querySelector('button');
                    deleteBtn.addEventListener('click', function() {
                        const postId = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this post?')) {
                            deletePost(postId);
                            broadcastPost({ id: postId }, 'post_deleted');
                            showToast('Post deleted');
                        }
                    });
                    
                    postsContainer.appendChild(postElement);
                });
            }
            
            function updateConnectionCount() {
                connectionCount.textContent = connections.size + ' peers connected';
            }
            
            function updatePeerList() {
                if (connections.size === 0) {
                    peerList.innerHTML = '<div class="empty-state">No peers connected yet</div>';
                    return;
                }
                
                peerList.innerHTML = '';
                connections.forEach((conn, peerId) => {
                    const peerItem = document.createElement('div');
                    peerItem.className = 'peer-item';
                    peerItem.innerHTML = `
                        <span>${peerId}</span>
                        <button class="btn-danger btn-small" data-peer="${peerId}">Disconnect</button>
                    `;
                    
                    const disconnectBtn = peerItem.querySelector('button');
                    disconnectBtn.addEventListener('click', function() {
                        const peerId = this.getAttribute('data-peer');
                        disconnectPeer(peerId);
                    });
                    
                    peerList.appendChild(peerItem);
                });
            }
            
            function disconnectPeer(peerId) {
                const conn = connections.get(peerId);
                if (conn) {
                    conn.close();
                    connections.delete(peerId);
                    updateConnectionCount();
                    updatePeerList();
                    showToast('Disconnected from peer: ' + peerId);
                }
            }
            
            function loadPostsFromStorage() {
                const postsJson = localStorage.getItem('posts');
                if (postsJson) {
                    try {
                        const postsArray = JSON.parse(postsJson);
                        posts = new Map(postsArray);
                    } catch (e) {
                        console.error('Error parsing posts from localStorage:', e);
                        posts = new Map();
                    }
                }
            }
            
            function savePostsToStorage() {
                const postsArray = Array.from(posts.entries());
                localStorage.setItem('posts', JSON.stringify(postsArray));
            }
            
            function clearLocalPosts() {
                if (confirm('Are you sure you want to clear all local posts? This cannot be undone.')) {
                    posts.clear();
                    savePostsToStorage();
                    renderPosts();
                    showToast('All posts cleared');
                }
            }
            
            function copyPeerId() {
                myPeerIdInput.select();
                document.execCommand('copy');
                showToast('Peer ID copied to clipboard');
            }
            
            function generateNewPeerId() {
                const newPeerId = 'postboard-' + Math.random().toString(36).substr(2, 8);
                localStorage.setItem('peerId', newPeerId);
                myPeerIdInput.value = newPeerId;
                
                if (peer) {
                    peer.destroy();
                }
                
                initializePeer();
                showToast('New peer ID generated');
            }
            
            function focusOnPeerInput() {
                connectToPeerInput.focus();
            }
            
            function showToast(message) {
                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            // Utility functions
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }
            
            function getTimeAgo(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (days > 0) return `${days} day${days !== 1 ? 's' : ''} ago`;
                if (hours > 0) return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                if (minutes > 0) return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                return 'Just now';
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        });
    </script>
</body>
</html>
